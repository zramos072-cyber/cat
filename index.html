<!DOCTYPE html>
<html>
<head>
    <title>Teachable Machine Audio Model</title>
</head>
<body>
    <h1>Teachable Machine Audio Model</h1>
    <button type="button" onclick="init()">Start Classification</button>
    <div id="label-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

    <script type="text/javascript">
        // *** IMPORTANT: REPLACE THIS URL with your actual Dog Model URL ***
        const URL = "https://teachablemachine.withgoogle.com/models/YOUR_DOG_MODEL_ID_HERE/"; 
        const PROBABILITY_THRESHOLD = 0.75; // Only send result if confidence is >= 75%

        async function createModel() {
            const checkpointURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            const recognizer = speechCommands.create(
                "BROWSER_FFT",
                undefined,
                checkpointURL,
                metadataURL
            );

            await recognizer.ensureModelLoaded();
            return recognizer;
        }

        async function init() {
            const recognizer = await createModel();
            const classLabels = recognizer.wordLabels();
            const labelContainer = document.getElementById("label-container");
            labelContainer.innerHTML = ''; // Clear label container

            // Create divs for all labels
            for (let i = 0; i < classLabels.length; i++) {
                labelContainer.appendChild(document.createElement("div"));
            }

            recognizer.listen(result => {
                const scores = result.scores;

                // --- Find the best prediction ---
                let maxScore = -Infinity;
                let topClassLabel = '';

                for (let i = 0; i < scores.length; i++) {
                    // Find the label with the highest score
                    if (scores[i] > maxScore) {
                        maxScore = scores[i];
                        topClassLabel = classLabels[i];
                    }
                    
                    // Update the visible scores on the web page
                    const classPrediction = classLabels[i] + ": " + (scores[i] * 100).toFixed(1) + "%";
                    labelContainer.childNodes[i].innerHTML = classPrediction;
                }

                // *** CRUCIAL App Inventor Communication ***
                // The `window.AppInventor.setWebViewString` function is what fires the 
                // `when CustomWebView1 .WebviewStringChanged` block in your app.
                if (window.AppInventor) {
                    let resultToSend;
                    
                    if (maxScore >= PROBABILITY_THRESHOLD && topClassLabel !== '_background_noise_') {
                        // Send the confident classification (e.g., "Growling")
                        resultToSend = topClassLabel;
                    } else {
                        // Send a neutral message if not confident, which your App Inventor blocks will treat as non-distress
                        resultToSend = "Background Noise"; 
                    }
                    
                    // Send the final result back to the App Inventor App
                    window.AppInventor.setWebViewString(resultToSend);
                }

            }, {
                includeSpectrogram: true,
                probabilityThreshold: 0.01, // Set low here to get all scores, but use our PROBABILITY_THRESHOLD above
                invokeCallbackOnNoiseAndUnknown: true,
                overlapFactor: 0.50
            });
            
            // Disable the Start button after it's clicked
            document.querySelector('button').disabled = true;
            document.querySelector('button').innerText = 'Listening...';
        }
    </script>
</body>
</html>
